
Функция  СоздатьАкты(Период)  Экспорт  

	 НачалоМесяца = НачалоМесяца(Период);
    КонецМесяца  = КонецМесяца(Период);
    ТекущийПользователь = Пользователи.ТекущийПользователь();
    
    Результат = Новый Массив;
	
    // 1. Получаем все действующие договоры и ищем реализации за период
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |	Договоры.Ссылка КАК Договор,
        |	Договоры.Организация КАК Организация,
        |	Договоры.Владелец КАК Контрагент,
        |	Договоры.ВКМ_СуммаАбонентскойПлаты КАК СуммаПлаты,
        |	ЕСТЬNULL(Реализации.Ссылка, ЗНАЧЕНИЕ(Документ.РеализацияТоваровУслуг.ПустаяСсылка)) КАК СуществующаяРеализация
        |ИЗ
        |	Справочник.ДоговорыКонтрагентов КАК Договоры
        |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализации
        |		ПО Договоры.Ссылка = Реализации.Договор
        |			И Реализации.Дата МЕЖДУ &НачалоМесяца И &КонецМесяца
        |			И НЕ Реализации.ПометкаУдаления
        |ГДЕ
        |	НЕ Договоры.ПометкаУдаления
        |	И Договоры.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.ВКМ_АбонентскоеОбслуживание)
        |	И (Договоры.ВКМ_НачалоДействияДоговора <= &КонецМесяца ИЛИ Договоры.ВКМ_НачалоДействияДоговора = ДАТАВРЕМЯ(1, 1, 1))
        |	И (Договоры.ВКМ_ОкончаниеДействияДоговора >= &НачалоМесяца ИЛИ Договоры.ВКМ_ОкончаниеДействияДоговора = ДАТАВРЕМЯ(1, 1, 1))";
    
    Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца);
    Запрос.УстановитьПараметр("КонецМесяца",  КонецМесяца);
    
    Выборка = Запрос.Выполнить().Выбрать();
    Всего = Выборка.Количество();
    Счетчик = 0;

    Пока Выборка.Следующий() Цикл
        Счетчик = Счетчик + 1;
        
        // 2. Если документ есть - получаем объект для перезаполнения, если нет - создаем
        Если Выборка.СуществующаяРеализация.Пустая() Тогда
            ДокументОбъект = Документы.РеализацияТоваровУслуг.СоздатьДокумент();
            ДокументОбъект.Дата = КонецДня(КонецМесяца);
        Иначе
            ДокументОбъект = Выборка.СуществующаяРеализация.ПолучитьОбъект();
        КонецЕсли;
        
        // 3. Актуализация данных шапки
        ДокументОбъект.Организация   = Выборка.Организация;
        ДокументОбъект.Контрагент    = Выборка.Контрагент;
        ДокументОбъект.Договор       = Выборка.Договор;
        ДокументОбъект.Ответственный = ТекущийПользователь;
        
        Если ДокументОбъект.ЭтоНовый() Тогда
            ДокументОбъект.Заполнить(Неопределено);
        КонецЕсли;

        // 4. Перезаполнение ТЧ для актуализации данных
        ДокументОбъект.Услуги.Очистить();
        НоваяСтрока = ДокументОбъект.Услуги.Добавить();
        НоваяСтрока.Количество = 1;
        НоваяСтрока.Цена       = Выборка.СуммаПлаты;
        НоваяСтрока.Сумма      = Выборка.СуммаПлаты;
        
        ДокументОбъект.ВыполнитьАвтозаполнение();
        
        // 5. Запись с учетом статуса проведения
        РежимЗаписи = ?(ДокументОбъект.Проведен, РежимЗаписиДокумента.Проведение, РежимЗаписиДокумента.Запись);
        ДокументОбъект.Записать(РежимЗаписи); 
        
        Результат.Добавить(Новый Структура("Договор, Реализация", Выборка.Договор, ДокументОбъект.Ссылка));
        
        ДлительныеОперации.СообщитьПрогресс(Цел((Счетчик / Всего) * 100), "Обработка: " + Строка(Выборка.Договор));
    КонецЦикла;
    
    Возврат Результат;	
КонецФункции   
   

